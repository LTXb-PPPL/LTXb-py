import numpy as np

from toolbox.helpful_stuff import closest

"""
This data refers to instrument function of PROPOSED LTX design, not actual ANPA from UW
This data was pulled from a plot received from Polosatkin using https://plotdigitizer.com/app
Plot is located in /Dropbox/work_stuff/npa_design/LTX_model_efficiency.png
For this data I traced the red curves
"""
ch0xy = [[0., 5., 5.668562144597888, 5.980503655564582, 6.23395613322502, 6.526401299756296, 6.799350121852153,
          7.0722989439480095, 7.403736799350122, 7.637692932575142, 7.9106417546709995, 8.222583265637693,
          8.515028432168968, 8.768480909829407, 10., 15., 20., 30.],
         [0., 0., 0.00040404040404040404, 0.0012121212121212121, 0.0016161616161616162, 0.00202020202020202,
          0.0024242424242424242, 0.0024242424242424242, 0.00202020202020202, 0.00202020202020202, 0.0016161616161616162,
          0.0012121212121212121, 0.00040404040404040404, 0., 0., 0., 0., 0., ]]
ch1xy = [[0., 4.0, 6.097481722177092, 6.9553208773355, 7.442729488220959, 7.715678310316815, 7.949634443541836,
          8.125101543460602, 8.320064987814785, 8.651502843216896, 8.943948009748173, 9.197400487408611,
          9.509341998375305, 10., 12., 20., 30.],
         [0., 0., 0.0008080808080808081, 0.0012121212121212121, 0.0024242424242424242, 0.0032323232323232323,
          0.0036363636363636364, 0.00404040404040404, 0.0036363636363636364, 0.0032323232323232323, 0.00202020202020202,
          0.0012121212121212121, 0.0008080808080808081, 0., 0., 0., 0.]]
ch2xy = [[0., 6., 8.125101543460602, 8.320064987814785, 8.534524776604387, 8.807473598700245, 9.060926076360683,
          9.275385865150284, 9.470349309504467, 9.645816409423233, 9.879772542648254, 10.055239642567019,
          10.250203086921204, 10.406173842404549, 10.581640942323315, 10.737611697806662, 10.932575142160845,
          11.108042242079609, 12., 14., 20., 30.],
         [0., 0., 0.00040404040404040404, 0.0008080808080808081, 0.0008080808080808081, 0.00202020202020202,
          0.0044444444444444444, 0.006060606060606061, 0.007676767676767677, 0.008888888888888889, 0.008888888888888889,
          0.007676767676767677, 0.0052525252525252525, 0.0036363636363636364, 0.0028282828282828283,
          0.00202020202020202, 0.0012121212121212121, 0.0008080808080808081, 0., 0., 0., 0.]]
ch3xy = [[0., 8., 9.43135662063363, 9.587327376116978, 9.782290820471161, 10.0357432981316, 10.211210398050365,
          10.347684809098293, 10.503655564581642, 10.64012997562957, 10.796100731112917, 10.952071486596264,
          11.108042242079609, 11.283509341998375, 11.478472786352558, 11.614947197400488, 11.770917952883835,
          11.9463850528026, 12.06336311941511, 12.258326563769295, 12.433793663688059, 12.648253452477661,
          12.804224207961008, 14., 16., 20., 30.],
         [0., 0., 0., 0.0008080808080808081, 0.0016161616161616162, 0.0024242424242424242, 0.0044444444444444444,
          0.0056565656565656566, 0.007676767676767677, 0.009292929292929294, 0.010505050505050505, 0.011717171717171716,
          0.01292929292929293, 0.01292929292929293, 0.011717171717171716, 0.010505050505050505, 0.00808080808080808,
          0.007272727272727273, 0.0048484848484848485, 0.0028282828282828283, 0.0016161616161616162,
          0.0008080808080808081, 0.00040404040404040404, 0., 0., 0., 0.]]
ch4xy = [[0., 6., 8., 10.874086108854591, 11.01056051990252, 11.186027619821283, 11.322502030869213, 11.478472786352558,
          11.71242891957758, 11.887896019496345, 12.024370430544273, 12.141348497156784, 12.258326563769295,
          12.394800974817223, 12.550771730300568, 12.687246141348497, 12.804224207961008, 12.960194963444355,
          13.135662063363121, 13.272136474411049, 13.38911454102356, 13.525588952071487, 13.642567018683998,
          13.779041429731926, 13.876523151909018, 14.051990251827783, 14.188464662875711, 14.32493907392364,
          14.500406173842405, 14.695369618196588, 14.890333062550772, 16., 20., 30.],
         [0., 0., 0., 0., 0.0008080808080808081, 0.0012121212121212121, 0.00202020202020202, 0.0028282828282828283,
          0.0048484848484848485, 0.007676767676767677, 0.009696969696969697, 0.012525252525252526, 0.014949494949494949,
          0.018585858585858588, 0.02101010101010101, 0.02303030303030303, 0.024646464646464646, 0.025454545454545455,
          0.024646464646464646, 0.02303030303030303, 0.020606060606060607, 0.017777777777777778, 0.015353535353535354,
          0.012121212121212121, 0.010505050505050505, 0.007272727272727273, 0.0048484848484848485,
          0.0032323232323232323, 0.0024242424242424242, 0.0012121212121212121, 0., 0., 0., 0.]]
ch5xy = [[0., 10., 12.453290008123478, 12.687246141348497, 12.921202274573517, 13.174654752233955, 13.408610885458977,
          13.584077985377743, 13.740048740861088, 13.935012185215273, 14.09098294069862, 14.227457351746548,
          14.363931762794476, 14.461413484971569, 14.578391551584078, 14.773354995938261, 14.929325751421608,
          15.085296506904955, 15.241267262388302, 15.397238017871649, 15.533712428919578, 15.728675873273762,
          15.86515028432169, 16.00162469536962, 16.09910641754671, 16.216084484159218, 16.33306255077173,
          16.489033306255077, 16.625507717303005, 16.781478472786354, 16.995938261575954, 17.190901705930138,
          17.483346872461414, 17.697806661251015, 18.009748172217712, 20., 25., 30.],
         [0., 0., 0., 0.00040404040404040404, 0.0008080808080808081, 0.00202020202020202, 0.00404040404040404,
          0.006060606060606061, 0.008888888888888889, 0.012525252525252526, 0.01616161616161616, 0.019797979797979797,
          0.023434343434343433, 0.026262626262626262, 0.030303030303030304, 0.03434343434343434, 0.037171717171717175,
          0.03797979797979798, 0.03797979797979798, 0.037171717171717175, 0.03434343434343434, 0.030707070707070707,
          0.026666666666666665, 0.022626262626262626, 0.019393939393939394, 0.016565656565656565, 0.01292929292929293,
          0.0101010101010101, 0.007272727272727273, 0.0056565656565656566, 0.0036363636363636364, 0.00202020202020202,
          0.0012121212121212121, 0.0008080808080808081, 0.00040404040404040404, 0., 0., 0.]]
ch6xy = [
	[0., 10., 14., 14.305442729488222, 14.55889520714866, 14.851340373679935, 15.085296506904955, 15.299756295694557,
	 15.553208773354996, 15.86515028432169, 16.118602761982128, 16.33306255077173, 16.528025995125915,
	 16.703493095044678, 16.917952883834282, 17.112916328188465, 17.346872461413483, 17.561332250203087,
	 17.853777416734363, 18.048740861088547, 18.22420796100731, 18.380178716490658, 18.51665312753859,
	 18.653127538586517, 18.789601949634445, 18.94557270511779, 19.0625507717303, 19.218521527213646,
	 19.452477660438667, 19.66693744922827, 19.881397238017872, 20.13484971567831, 20.40779853777417, 20.77822908204712,
	 21.051177904142975, 21.304630381803413, 22., 24., 30.],
	[0., 0., 0., 0.00040404040404040404, 0.0008080808080808081, 0.0012121212121212121, 0.0024242424242424242,
	 0.0036363636363636364, 0.0056565656565656566, 0.0101010101010101, 0.015353535353535354, 0.020606060606060607,
	 0.02585858585858586, 0.03111111111111111, 0.03676767676767677, 0.04242424242424243, 0.04727272727272727,
	 0.050505050505050504, 0.05171717171717172, 0.050101010101010104, 0.04727272727272727, 0.04323232323232323,
	 0.039595959595959594, 0.03636363636363636, 0.03151515151515152, 0.027878787878787878, 0.02383838383838384,
	 0.019797979797979797, 0.013737373737373737, 0.009696969696969697, 0.006868686868686869, 0.00404040404040404,
	 0.00202020202020202, 0.0012121212121212121, 0.0008080808080808081, 0.00040404040404040404, 0., 0., 0.]]
ch7xy = [
	[0., 10., 16., 16.742485783915516, 17.327376116978066, 17.65881397238018, 17.931762794476036, 18.185215272136475,
	 18.47766043866775, 18.750609260763607, 18.965069049553207, 19.121039805036556, 19.335499593826157,
	 19.491470349309505, 19.68643379366369, 19.881397238017872, 20.03736799350122, 20.212835093419983,
	 20.36880584890333, 20.52477660438668, 20.700243704305443, 20.914703493095047, 21.070674248578392,
	 21.246141348497158, 21.343623070674248, 21.480097481722176, 21.597075548334686, 21.733549959382614,
	 21.889520714865963, 22.006498781478474, 22.1429731925264, 22.29894394800975, 22.435418359057678,
	 22.591389114541023, 22.76685621445979, 22.922826969943138, 23.11779041429732, 23.33225020308692, 23.6246953696182,
	 23.897644191714054, 24.17059301380991, 24.44354183590577, 26., 30.],
	[0., 0., 0., 0.00040404040404040404, 0.0008080808080808081, 0.0016161616161616162, 0.0024242424242424242,
	 0.00404040404040404, 0.007272727272727273, 0.011717171717171716, 0.01575757575757576, 0.020606060606060607,
	 0.026666666666666665, 0.03191919191919192, 0.039595959595959594, 0.04565656565656566, 0.05171717171717172,
	 0.057373737373737375, 0.06101010101010101, 0.06424242424242424, 0.06585858585858585, 0.06585858585858585,
	 0.06424242424242424, 0.06181818181818182, 0.05858585858585859, 0.055757575757575756, 0.05171717171717172,
	 0.04727272727272727, 0.041616161616161614, 0.037171717171717175, 0.03232323232323232, 0.027474747474747475,
	 0.022626262626262626, 0.01818181818181818, 0.014141414141414142, 0.01090909090909091, 0.007676767676767677,
	 0.0052525252525252525, 0.0028282828282828283, 0.0016161616161616162, 0.0008080808080808081,
	 0.00040404040404040404, 0., 0.]]
ch8xy = [[0., 10., 15., 19., 19.97887896019496, 20.446791226645004, 20.797725426482536, 21.148659626320068,
          21.44110479285134, 21.636068237205524, 21.81153533712429, 22.04549147034931, 22.220958570268074,
          22.435418359057678, 22.610885458976444, 22.786352558895206, 22.961819658813972, 23.078797725426483,
          23.234768480909832, 23.35174654752234, 23.527213647441105, 23.70268074735987, 23.936636880584892,
          24.131600324939075, 24.40454914703493, 24.638505280259952, 24.89195775792039, 25.067424857839157,
          25.242891957757923, 25.37936636880585, 25.49634443541836, 25.63281884646629, 25.769293257514217,
          25.905767668562145, 26.061738424045494, 26.178716490658, 26.276198212835094, 26.43216896831844,
          26.58813972380179, 26.763606823720554, 27.03655564581641, 27.231519090170593, 27.504467912266453,
          27.796913078797726, 28.01137286758733, 28.303818034118603, 28.732737611697807, 29.005686433793663, 30.],
         [0., 0., 0., 0., 0.00040404040404040404, 0.00040404040404040404, 0.0016161616161616162, 0.0032323232323232323,
          0.0056565656565656566, 0.007676767676767677, 0.0101010101010101, 0.013737373737373737, 0.017373737373737375,
          0.02303030303030303, 0.02909090909090909, 0.033939393939393936, 0.039595959595959594, 0.044444444444444446,
          0.0496969696969697, 0.05414141414141414, 0.06060606060606061, 0.06464646464646465, 0.0703030303030303,
          0.07353535353535354, 0.07595959595959596, 0.07474747474747474, 0.07111111111111111, 0.06747474747474748,
          0.06262626262626263, 0.05898989898989899, 0.05454545454545454, 0.04929292929292929, 0.044848484848484846,
          0.039595959595959594, 0.03474747474747475, 0.030707070707070707, 0.027474747474747475, 0.02303030303030303,
          0.01818181818181818, 0.014545454545454545, 0.0101010101010101, 0.007676767676767677, 0.0044444444444444444,
          0.0032323232323232323, 0.0016161616161616162, 0.0012121212121212121, 0.0008080808080808081, 0., 0.]]
ch9xy = [[0., 10., 20., 22., 22.805848903330627, 23.527213647441105, 23.975629569455727, 24.30706742485784,
          24.580016246953697, 24.91145410235581, 25.203899268887085, 25.437855402112106, 25.691307879772545,
          25.886271324126728, 26.042242079610073, 26.256701868399677, 26.43216896831844, 26.54914703493095,
          26.744110479285133, 26.880584890333065, 27.017059301380993, 27.134037367993503, 27.25101543460601,
          27.387489845653942, 27.562956945572704, 27.796913078797726, 28.030869212022747, 28.22583265637693,
          28.38180341186028, 28.55727051177904, 28.771730300568645, 29.025182778229084, 29.20064987814785,
          29.356620633631195, 29.473598700243706, 29.610073111291634, 29.707554833468727, 29.844029244516655,
          29.922014622258327, 30.],
         [0., 0., 0., 0., 0., 0.00040404040404040404, 0.0012121212121212121, 0.00202020202020202, 0.0036363636363636364,
          0.0052525252525252525, 0.008484848484848484, 0.012525252525252526, 0.016969696969696968, 0.019797979797979797,
          0.024646464646464646, 0.030303030303030304, 0.035555555555555556, 0.0404040404040404, 0.04606060606060606,
          0.052525252525252523, 0.057777777777777775, 0.06181818181818182, 0.06666666666666667, 0.07151515151515152,
          0.07878787878787878, 0.08606060606060606, 0.09292929292929293, 0.09818181818181818, 0.10101010101010101,
          0.10222222222222223, 0.10262626262626262, 0.10101010101010101, 0.09818181818181818, 0.09494949494949495,
          0.09171717171717171, 0.08767676767676767, 0.08444444444444445, 0.08040404040404041, 0.07676767676767676,
          0.07393939393939394]]


class NPA:
	def __init__(self):
		self.ch0 = ch0xy
		self.ch1 = ch1xy
		self.ch2 = ch2xy
		self.ch3 = ch3xy
		self.ch4 = ch4xy
		self.ch5 = ch5xy
		self.ch6 = ch6xy
		self.ch7 = ch7xy
		self.ch8 = ch8xy
		self.ch9 = ch9xy
		self.xdim = 'Energy (keV)'
		self.ydim = 'Detection Efficiency'
	
	def compute_channel_current(self, energy_ax, flux_vals):
		channels = [self.ch0, self.ch1, self.ch2, self.ch3, self.ch4, self.ch5, self.ch6, self.ch7, self.ch8, self.ch9]
		ch_centers = [chan[0][closest(chan[1], np.max(np.array(chan[1])))[1]] for chan in channels]  # [keV]
		ee = 1.602e-19
		ch_currents = [np.sum(np.interp(energy_ax, ch[0], ch[1]) * flux_vals) * ee for ch in channels]  # [A]
		return ch_centers, ch_currents


if __name__ == '__main__':
	pass
